<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Прямой доступ к статическим файлам (изображения, CSS, JS) - обход CakePHP для производительности
    # Если файл существует, отдаем его напрямую (приоритет 1 - проверяем первым для скорости)
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^(img|css|js|files)/(.*)$ - [L]
    
    # ============================================
    # Защита от ботов и rate limiting (только для публичных страниц)
    # ============================================
    # Исключаем админ-панель из проверок ботов для производительности импорта
    # НЕ используем [L] здесь, чтобы запрос продолжал обрабатываться CakePHP
    
    # Блокировка известных ботов и краулеров (кроме основных поисковых)
    # Разрешаем только Googlebot и Yandex для SEO
    # Пропускаем проверку для админ-панели
    RewriteCond %{REQUEST_URI} !^/admin [NC]
    RewriteCond %{REQUEST_URI} !^/app/webroot [NC]
    RewriteCond %{HTTP_USER_AGENT} ^.*(GPTBot|ClaudeBot|ChatGPT|OpenAI|anthropic|PetalBot|SemrushBot|AhrefsBot|MJ12bot|DotBot|Baiduspider|Sogou|Exabot|facebot|facebookexternalhit|meta-externalagent|Twitterbot|LinkedInBot|WhatsApp|SkypeUriPreview|Applebot|bingbot|Slurp|DuckDuckBot|BingPreview|ia_archiver|archive\.org_bot|msnbot|Amazonbot).* [NC]
    RewriteRule .* - [F,L]
    
    # Блокировка подозрительных User-Agent (исключая разрешенные поисковые боты)
    # Пропускаем проверку для админ-панели
    RewriteCond %{REQUEST_URI} !^/admin [NC]
    RewriteCond %{REQUEST_URI} !^/app/webroot [NC]
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} ^(curl|wget|python|java|perl|ruby|bash|shell|cmd|powershell).* [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} .*(libwww-perl|nikto|scan|sqlmap|nmap|masscan|zmap).* [NC,OR]
    # Блокируем ботов, но разрешаем Googlebot и Yandex
    RewriteCond %{HTTP_USER_AGENT} !(Googlebot|Yandex|YandexBot|YandexImages|YandexVideo|YandexMedia|YandexBlogs|YandexFavicons|YandexWebmaster|YandexPagechecker|YandexImageResizer|YandexMetrika|YandexDirect|YandexScreenshotBot|YandexAccessibilityBot|YandexMobileScreenShotBot|YandexCalendar|YandexSitelinks|YandexNews|YandexCatalog|YandexAntivirus|YandexMarket|YandexVertis|YandexForDomain|YandexSpravBot|YandexSearchShop|YandexMedianaBot|YandexOntoDB|YandexOntoDBAPI|YandexTurbo|YandexVerticals|YandexNotifier) [NC]
    RewriteCond %{HTTP_USER_AGENT} .*(harvest|extract|grab|miner|crawler|spider|bot|scraper).* [NC]
    RewriteRule .* - [F,L]
    
    # CakePHP routing rules
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]
</IfModule>

# Ограничение размера запроса (10MB)
LimitRequestBody 10485760
