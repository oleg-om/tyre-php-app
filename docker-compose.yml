# Универсальный docker-compose.yml для dev и prod окружений
# Окружение определяется через переменные окружения:
# - APP_ENV=dev (по умолчанию) - порт 8080, MySQL порт 3307
# - APP_ENV=prod - порты 80 и 443, MySQL порт 3306

services:
  tyre-app-php:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tyre-app-php
    ports:
      - "${HTTP_PORT:-8080}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - tyre-app-files:/var/www/html/app/webroot/files
      - tyre-app-ssl:/etc/apache2/ssl
      - ./app/webroot/.htaccess:/var/www/html/app/webroot/.htaccess
      - ./app/webroot/phpmy/config.inc.php:/var/www/html/app/webroot/phpmy/config.inc.php
      - ./app/webroot/phpmy/.htaccess:/var/www/html/app/webroot/phpmy/.htaccess
      - ./app/tmp:/var/www/html/app/tmp
      - ./app/Config:/var/www/html/app/Config
    environment:
      - DB_HOST=tyre-app-mysql
      - DB_PORT=3306
      - DB_NAME=${DB_NAME:-tyre_db}
      - DB_USER=${DB_USER:-tyre_user}
      - DB_PASSWORD=${DB_PASSWORD:-tyre_password}
      - PHPMYADMIN_USER=${PHPMYADMIN_USER:-admin}
      - PHPMYADMIN_PASSWORD=${PHPMYADMIN_PASSWORD:-admin_password}
      - APP_ENV=${APP_ENV:-dev}
      - ALLOWED_DOMAIN=${ALLOWED_DOMAIN:-}
    depends_on:
      - tyre-app-mysql
    networks:
      - tyre-app-network

  tyre-app-mysql:
    image: mysql:5.7
    platform: linux/amd64
    container_name: tyre-app-mysql
    ports:
      - "${MYSQL_PORT:-3307}:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root_password}
      - MYSQL_DATABASE=${DB_NAME:-tyre_db}
      - MYSQL_USER=${DB_USER:-tyre_user}
      - MYSQL_PASSWORD=${DB_PASSWORD:-tyre_password}
    volumes:
      - tyre-app-mysql-data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
      - ./dumps:/dumps
    command: --sql-mode="STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION" --character-set-server=utf8 --collation-server=utf8_general_ci
    networks:
      - tyre-app-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  tyre-app-mysql-data:
    driver: local
  tyre-app-files:
    driver: local
  tyre-app-ssl:
    driver: local

networks:
  tyre-app-network:
    driver: bridge
